.PHONY: compile-el compile-dl clean protoc mdbook-serve lint build unit-tests integration-tests integration-tests-churner integration-tests-indexer integration-tests-node-plugin integration-tests-eigenda-client integration-tests-inabox integration-tests-inabox-nochurner integration-tests-graph-indexer integration-tests-dataapi check-fmt

ifeq ($(wildcard .git/*),)
$(warning semver disabled - building from release zip)
GITCOMMIT := ""
GITSHA := ""
GITDATE := ""
BRANCH := ""
SEMVER := $(shell basename $(CURDIR))
else
GITCOMMIT := $(shell git rev-parse --short HEAD)
GITDATE := $(shell git log -1 --format=%cd --date=unix)
GITSHA := $(shell git rev-parse HEAD)
BRANCH := $(shell git rev-parse --abbrev-ref HEAD | sed 's/[^[:alnum:]\.\_\-]/-/g')
SEMVER := $(shell docker run --rm --volume "$(PWD):/repo" gittools/gitversion:5.12.0 /repo -output json -showvariable SemVer)
ifeq ($(SEMVER), )
$(warning semver disabled - docker not installed)
SEMVER := "0.0.0"
endif
endif

RELEASE_TAG := $(or $(RELEASE_TAG),latest)

contract-bindings:
	$(MAKE) -C contracts bindings

clean:
	$(MAKE) -C api clean

# Builds the protobuf files
protoc:
	$(MAKE) -C api protoc

# Only lints the diff between current branch and master because of settings in .golangci.yml unless a different branch is specified in LINT_BASE_REV
lint:
	golangci-lint run $(if $(LINT_BASE_REV),--new-from-rev=$(LINT_BASE_REV))
	go mod tidy -diff

# TODO: this should also format github workflows, etc.
fmt:
	$(MAKE) -C contracts fmt
	go fmt ./...

# TODO: this should also check github workflows, etc.
fmt-check:
	$(MAKE) -C contracts fmt-check
	# go list template was generated by Claude. I didn't double check that it expands to the exact
	# same files as `go fmt ./...`, but it should be equivalent.
	output=$$(gofmt -l $$(go list -f '{{range .GoFiles}}{{$$.Dir}}/{{.}} {{end}}' ./...)); \
	if [ -n "$$output" ]; then \
		echo "Files not gofmt'd:"; \
		echo "$$output"; \
		exit 1; \
	fi

# Go's VCS stamping logic assumes .git is always a directory, but in worktrees it's a file.
# This causes "error obtaining VCS status" when building because Go can't parse the file format.
# See https://github.com/golang/go/issues/58218#issuecomment-1471302281
#
# So we detect if we're in a git worktree (where .git is a file, not a directory)
# and set GOFLAGS to disable VCS stamping to avoid build errors if so.
# This is a temporary workaround until Go's VCS handling is fixed.
ifeq ($(shell test -f .git && echo "true"),true)
export GOFLAGS := -buildvcs=false
$(warning Detected git worktree - disabling VCS stamping)
endif
build:
	cd operators/churner && make build
	cd disperser && make build
	cd node && make build
	cd retriever && make build
	cd tools/traffic && make build
	cd tools/kzgpad && make build
	cd relay && make build
	cd litt && make build

# builds all services and loads them into dockerd (such that they are available via `docker images`).
# The images will be tagged with :dev, which is the default BUILD_TAG in docker-bake.hcl.
# This can be changed by running for example `BUILD_TAG=master make docker-build`.
docker-build:
	docker buildx bake all --load

# builds all services and pushes them to the configured registry (ghcr by default).
docker-build-push:
	docker buildx bake all --push

# Should only ever be used by the docker-publish-release CI workflow.
# We keep the node-group and proxy targets separate since we might want to release them separately in the future.
docker-release-build:
	BUILD_TAG=${SEMVER} SEMVER=${SEMVER} GITDATE=${GITDATE} GIT_SHA=${GITSHA} GIT_SHORT_SHA=${GITCOMMIT} \
	docker buildx bake node-group-release ${PUSH_FLAG}
	BUILD_TAG=${SEMVER} SEMVER=${SEMVER} GITDATE=${GITDATE} GIT_SHA=${GITSHA} GIT_SHORT_SHA=${GITCOMMIT} \
	docker buildx bake proxy-release ${PUSH_FLAG}

# Some of the unit test suites take > 1 min to run (e.g. relay and littdb tests).
# TODO: we should break these up into short and long unit-tests.
unit-tests:
	go clean -testcache
	CI=true go test -short ./... -coverprofile=coverage.out

fuzz-tests:
	go test --fuzz=FuzzParseSignatureKMS -fuzztime=1m ./common
	go test --fuzz=FuzzBlobConversion -fuzztime=1m ./api/clients/v2/coretypes

# Integration tests use mocks
integration-tests:
	go test -v ./operators/churner/tests
	go test -v ./core/indexer
	go test -v ./node/plugin/tests
	go test -v ./disperser/dataapi

# Tests that require a build because they start local inabox infra:
# either chain, subgraph, or localstack.
integration-tests-inabox: build
	cd inabox && make run-e2e
#   TODO: TestIndexerIntegration in core/thegraph/state_integration_test.go fails to start its inabox dependency...
#         Seems like it was never run in CI, and I don't know how to fix it, so just commenting and will let someone else fix.
# 	go test -v ./core/thegraph

# These are e2e tests that run against live environments (preprod and holesky currently).
live-tests:
	go test -v ./test/v2/live -v -timeout 60m
live-tests-v1:
	go test -v ./api/clients --live-test

semver:
	echo "${SEMVER}"

##### Proxies to other local Makefiles #####
mdbook-serve:
	$(MAKE) -C docs/spec serve