name: Live Network Tests

on:
  schedule:
    - cron: '0 6,18 * * *'   # Runs daily at 6 AM and 6 PM UTC
  workflow_dispatch: {}         # Allow manual triggering
  push: # temporary
    branches:
      - auto-test

jobs:
  test:
    runs-on: ubuntu-latest

#    env:
#      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
#      OTHER_SECRET: ${{ secrets.OTHER_SECRET }}
#      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: go mod download

      - name: Run Live Network Tests
        run: go test ./test/v2/live -v

      - name: Notify Slack
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            COLOR="good"
            STATUS_EMOJI="✅"
            MENTION=""
          else
            COLOR="danger"
            STATUS_EMOJI="❌"
            MENTION="<@here> "
          fi

          PAYLOAD=$(jq -n \
            --arg channel "#da-live-tests" \
            --arg text "${MENTION}Live Network Tests completed with status: ${STATUS_EMOJI} ${{ job.status }}" \
            --arg title "View Run" \
            --arg title_link "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg color "$COLOR" \
            '{
              channel: $channel,
              text: $text,
              attachments: [
                {
                  color: $color,
                  title: $title,
                  title_link: $title_link
                }
              ]
            }')

          curl -X POST -H "Authorization: Bearer ${{ secrets.DA_TEST_REPORTER_SLACK_OATH_TOKEN }}" \
               -H 'Content-type: application/json; charset=utf-8' \
               --data "$PAYLOAD" \
               https://slack.com/api/chat.postMessage