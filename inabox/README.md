# Inabox Tests

Notice: The scripts for setting up a local geth chain are currently broken. The instructions below use anvil instead

## First time setup
- Go path is in system path
- Ensure all submodules are initialized and checked out
    ```
    git submodule update --init --recursive
    ```
- Ensure foundry is installed (comes with `anvil` which we use as a test chain and `forge` which we use for deployment scripting):
    ```
    $ curl -L https://foundry.paradigm.xyz | bash
    $ foundryup
    ```
- Localstack CLI is installed (simulates AWS stack on local machine; we also provide instructions for running localstack from docker without the CLI):
    ```
    $ brew install localstack/tap/localstack-cli
    ```
- grpcurl is installed:
    ```
    go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest
    ```

## Run a complete end-to-end test

You can run a complete end-to-end test by running the following command:
```
cd inabox
make run-e2e
```

## Manually deploy the experiment and interact with the services

### Preliminary setup steps

Ensure that all submodules (e.g. EigenLayer smart contracts) are checked out to the correct branch, and then build the binaries.
```
$ git submodule update --init --recursive
$ make build
```

Create a new configuration file:
```
cd inabox
make new-anvil
```

This will create a new file, e.g. `./testdata/12D-07M-2023Y-14H-41M-19S/config.yaml`. Please feel free to inspect the file and make any desired configuration changes at this point. After you have deployed the experiment, changes will not go into effect. 


### Provision the test infrastructure, deploy contracts, and configure services

#### Option 1 (simplest): 

Run the following command (from inabox directory)
```
make deploy-all
```

This will
- Start all test infrastructure (localstack, graph node, anvil chain)
- Create the necessary AWS resources on localstack
- Deploy the smart contracts to anvil
- Deploy subgraphs to the graph node
- Create configurations for the eigenda services (located in `inabox/testdata/DATETIME/envs`)

To view the logs generated by the graph node, run the following command

```
cd thegraph
docker compose logs -f
```

The localstack logs can also be viewed by finding the localstack container and running the appropriate docker logs command. Option 1 does not allow for easy viewing of the chain (anvil logs). If you wish to be able to view the chain logs, please use [Option 2](#option-2) instead.

#### Option 2:

NOTE!!: If you already completed Option 1, don't follow the steps in Option 2; skip to the next section.

This option allows you to manually set up the test infrastructure and deployment steps for troubleshooting purposes. 

Terminal 1: Start anvil
```
anvil --host 0.0.0.0
```

Terminal 2: Start the graph node
```
cd inabox/thegraph 
docker compose up
```

Terminal 3: Start localstack
```
GATEWAY_LISTEN=0.0.0.0:4570 LOCALSTACK_HOST=localhost.localstack.cloud:4570 localstack start
```

The `make infra` command provides an alternative which runs all test infra in the background. This command has no dependence on the localstack cli. 

Terminal 4: Create the AWS resources on localstack
```
cd inabox 
make resources
```

Terminal 4: Deploy the contracts and create test configurations
```
$ make exp
```

You should see the following output:
```
./setup.sh deploy
Running experiment in ./testdata/12D-07M-2023Y-14H-41M-19S/
2023/07/12 14:41:24 Deploying experiment...
Deploying EigenDA
Generating variables
Test environment has successfully deployed!
```

If there are any deployment errors, look at `inabox/testdata/DATETIME/deploy.log` for a detailed log. 

To view the configurations created for the EigenDA service components, look in `inabox/testdata/DATETIME/envs`

### Run the binaries and send traffic

Run the binaries:
```
cd inabox
./bin.sh start
```
This will print all logs from the EigenDA services to the screen; `Ctrl+C` will stop all services. Inspect the logs to make sure all binaries started without any errors. 

Alternatively, you can start and stop the EigenDA services in detached mode by running `./bin.sh start-detached` and `./bin.sh stop-detached`, respectively. In this case, the logs are saved to `inabox/testdata/DATETIME/logs`.

Disperse a blob:
```
# This command uses `grpcurl`, a tool to send gRPC request in cli
# To install `grpcurl`, run `brew install grpcurl` or `go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest`

$ grpcurl -plaintext -d '{"data": "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", "security_params": [{"quorum_id": 0, "adversary_threshold": 50, "quorum_threshold": 100}]}' localhost:32003 disperser.Disperser/DisperseBlob
```

Look for logs such as the following to indicate that the disperser has successfully confirmed the batch:
```
TRACE[10-12|22:02:13.365] [batcher] Aggregating signatures...      caller=batcher.go:178
DEBUG[10-12|22:02:13.371] Exiting process batch                    duration=110ns caller=node.go:222
DEBUG[10-12|22:02:13.371] Exiting process batch                    duration=80ns  caller=node.go:222
DEBUG[10-12|22:02:13.373] Exiting process batch                    duration=100ns caller=node.go:222
DEBUG[10-12|22:02:13.373] Exiting process batch                    duration=160ns caller=node.go:222
TRACE[10-12|22:02:13.376] [batcher] AggregateSignatures took       duration=10.609723ms  caller=batcher.go:195
TRACE[10-12|22:02:13.376] [batcher] Confirming batch...            caller=batcher.go:198
```

### Cleanup

If you followed [Option 1](#option-1-simplest) above, you can run the following command in order to clean up the test infra:
```
cd inabox
make stop-infra
```

If you followed [Option 2](#option-2), you can stop the infra services by `Ctrl-C`'ing in each terminal. For the graph, it's also important to run `docker compose down -v` from within the `inabox/thegraph` directory to make sure that the containers are fully removed. 
